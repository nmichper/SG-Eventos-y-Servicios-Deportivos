<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Booking System</title>
<style>
body { font-family: Arial; text-align:center; margin-top:40px; }
form { max-width:400px; margin:auto; }
input, select, button { width:100%; padding:10px; margin:8px 0; }
</style>
</head>
<body>

<h2>Book Appointment</h2>

<form id="bookingForm">
  <input type="text" id="name" placeholder="Full Name" required>
  <input type="email" id="email" placeholder="Your Email" required>
  <input type="date" id="date" required>

  <select id="time" required>
    <option value="">Select Time</option>
  </select>

  <button type="submit">Book Appointment</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  doc, 
  runTransaction 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = YOUR_FIREBASE_CONFIG;

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const timeSelect = document.getElementById("time");
const dateInput = document.getElementById("date");

/* âœ… CORRECT SCHEDULE */

const mwfSlots = [
  "08:30-09:30",
  "09:30-11:00",
  "17:00-18:30",
  "18:30-20:00"
];

const ttSlots = [
  "17:00-18:30",
  "18:30-20:00"
];

/* ===============================
   LOAD AVAILABLE SLOTS
================================ */

dateInput.addEventListener("change", async () => {

  timeSelect.innerHTML = '<option value="">Select Time</option>';

  const selectedDate = new Date(dateInput.value);
  const day = selectedDate.getDay(); // 0=Sun

  let allowedSlots = [];

  if ([1,3,5].includes(day)) {
    allowedSlots = mwfSlots;
  } 
  else if ([2,4].includes(day)) {
    allowedSlots = ttSlots;
  } 
  else {
    alert("Bookings available Monday to Friday only.");
    dateInput.value = "";
    return;
  }

  for (let slot of allowedSlots) {

    const docId = `${dateInput.value}_${slot}`;
    const bookingRef = doc(db, "bookings", docId);

    const snap = await fetchDoc(bookingRef);

    if (!snap.exists) {
      let option = document.createElement("option");
      option.value = slot;
      option.textContent = slot;
      timeSelect.appendChild(option);
    }
  }
});

/* Helper to safely check doc */
async function fetchDoc(ref){
  const { getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
  return await getDoc(ref);
}

/* ===============================
   BOOKING SUBMIT
================================ */

document.getElementById("bookingForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const date = document.getElementById("date").value;
  const time = document.getElementById("time").value;

  if(!time){
    alert("Please select available time.");
    return;
  }

  const docId = `${date}_${time}`;
  const bookingRef = doc(db, "bookings", docId);

  try {

    await runTransaction(db, async (transaction) => {

      const bookingDoc = await transaction.get(bookingRef);

      if (bookingDoc.exists()) {
        throw "This slot is already booked.";
      }

      transaction.set(bookingRef, {
        name,
        email,
        date,
        time,
        createdAt: new Date()
      });

    });

    /* ===============================
       SEND EMAIL TO TWO ADDRESSES
    ================================= */

    await fetch("YOUR_FORMSPREE_URL",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        subject: "New Tennis Court Booking",
        message: `
New Booking:

Name: ${name}
Email: ${email}
Date: ${date}
Time: ${time}
        `,
        // Formspree supports comma-separated recipients
        _replyto: email,
        _cc: "adrirodriguezmartin10@gmail.com,samuelbarlovento@gmail.com"
      })
    });

    alert("Appointment successfully booked!");
    e.target.reset();
    timeSelect.innerHTML = '<option value="">Select Time</option>';

  } catch (error) {
    alert(error);
  }
});
</script>
